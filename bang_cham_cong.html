
{% extends "layout.html" %}
{% block title %}B·∫£ng ch·∫•m c√¥ng{% endblock %}

{% block content %}
<style>
  /* Hi·ªÉn th·ªã tr√™n tr√¨nh duy·ªát */
  .table .hoten {
    min-width: 200px;
    max-width: 250px;
    white-space: normal;
    word-break: break-word;
  }

  .weekend-holiday {
    background-color: #f4cccc !important;
  }

  @media print {
    @page {
      size: A4 landscape;
      margin: 1cm 1cm 1cm 1.5cm;
    }

    html, body {
      width: 100%;
      font-size: 13px;
      zoom: 100% !important;
    }

    * {
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }

    .table th, .table td {
      padding: 2px 4px;
      font-size: 12px;
    }

    .table .hoten {
      min-width: 180px;
      white-space: normal;
      word-break: break-word;
    }

    .cot-ngay {
      width: 2.5%;
      text-align: center;
    }

    .d-none.d-print-block {
      display: block !important;
    }

    .no-print {
      display: none !important;
    }

    .weekend-holiday {
      background-color: #d9ead3 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>

<!-- TI√äU ƒê·ªÄ CHU·∫®N C√îNG VƒÇN -->
<div class="d-none d-print-block text-center mb-3">
  <div class="row">
    <div class="col-6 text-start">
      <strong>B·ªÜNH VI·ªÜN NHI T·ªàNH GIA LAI</strong><br>
      {% if selected_department %}
      <span style="display:inline-block; font-weight:bold; border-bottom:1px solid black; margin-left:25px;">
        {{ selected_department.upper() }}
      </span>
      {% endif %}
    </div>
    <div class="col-6 text-center">
      <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-weight: normal; border-bottom: 1px solid black;">
          ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c
        </span>
      </div>
      {% if now %}
      <div style="margin-top: 4px;">
        <em>Gia Lai, ng√†y {{ now.strftime('%d') }} th√°ng {{ now.strftime('%m') }} nƒÉm {{ now.strftime('%Y') }}</em>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="d-print-block mb-3" style="width: 100%;">
  <h5 class="mt-4 mb-3 fw-bold text-uppercase"
      style="position: relative; left: 50%; transform: translateX(-50%); text-align: center;">
    B·∫¢NG CH·∫§M C√îNG TH√ÅNG {{ month }} NƒÇM {{ year }}
  </h5>
</div>

<form method="GET" class="d-flex gap-3 flex-wrap align-items-end mb-4">
  <div>
    <label for="department" class="form-label mb-0">Khoa/Ph√≤ng:</label>
    <select name="department" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
      {% for dept in departments %}
        <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label for="contract_type" class="form-label mb-0">Lo·∫°i h·ª£p ƒë·ªìng:</label>
    <select name="contract_type" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
      <option value="bi√™n ch·∫ø" {% if selected_contract == 'bi√™n ch·∫ø' %}selected{% endif %}>Bi√™n ch·∫ø</option>
      <option value="h·ª£p ƒë·ªìng" {% if selected_contract == 'h·ª£p ƒë·ªìng' %}selected{% endif %}>H·ª£p ƒë·ªìng</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-0">T·ª´ ng√†y:</label>
    <input type="date" name="start" class="form-control" value="{{ start_date }}">
  </div>
  <div>
    <label class="form-label mb-0">ƒê·∫øn ng√†y:</label>
    <input type="date" name="end" class="form-control" value="{{ end_date }}">
  </div>
  <div>
    <button type="submit" class="btn btn-primary">Xem b·∫£ng</button>
  </div>
  <div>
    <a href="/export-cham-cong?start={{ start_date }}&end={{ end_date }}&department={{ selected_department }}&contract_type={{ selected_contract }}" class="btn btn-success">üì• Xu·∫•t Excel</a>
    <button type="button" class="btn btn-secondary" onclick="window.print()">üñ® In</button>
  </div>
</form>

<table class="table table-bordered table-sm">
  <thead>
    <tr>
      <th colspan="3" style="background-color:#d9ead3; font-weight:bold;">
        {% if print_filter and selected_contract %}
          {{ selected_contract.upper() }}
        {% else %}
          BI√äN CH·∫æ
        {% endif %}
      </th>
      <th colspan="{{ days_in_month|length }}" style="background-color:#fff2cc; font-weight:bold;">NG√ÄY TRONG TH√ÅNG</th>
      <th colspan="4" style="background-color:#d9ead3;"></th>
    </tr>
    <tr>
      <th>STT</th>
      <th class="hoten">H·ªç v√† t√™n</th>
      <th>Ch·ª©c danh</th>
      {% for day in days_in_month %}
        <th class="cot-ngay">{{ "%02d"|format(day.day) }}</th>
      {% endfor %}
      <th class="ketthuc">S·ªë c√¥ng<br>kh√¥ng h∆∞·ªüng l∆∞∆°ng</th>
      <th class="ketthuc">S·ªë c√¥ng<br>h∆∞·ªüng l∆∞∆°ng th·ªùi gian</th>
      <th class="ketthuc">S·ªë c√¥ng<br>ngh·ªâ vi·ªác h∆∞·ªüng 100%</th>
      <th class="ketthuc">S·ªë c√¥ng<br>BHXH</th>
    </tr>
    <tr>
      <th></th><th></th><th></th>
      {% set thu_map = ['CN','T2','T3','T4','T5','T6','T7'] %}
      {% for day in days_in_month %}
        <th class="cot-ngay">{{ thu_map[day.weekday()] }}</th>
      {% endfor %}
      <th></th><th></th><th></th><th></th>
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
      {% if not print_filter or (selected_contract and user.contract_type == selected_contract) %}
    <tr>
      <td>{{ loop.index }}</td>
      <td class="hoten">{{ user.name }}</td>
      <td>{{ user.position }}</td>
      {% for day in days_in_month %}
        {% set is_weekend = day.weekday() in [5,6] %}
        {% set is_holiday = day in holidays %}
        <td class="cot-ngay {% if is_weekend or is_holiday %}weekend-holiday{% endif %}">
          {% set raw = schedule_map.get((user.id, day), '') %}
          {% if raw and raw|length > 2 and raw[-2:].isdigit() %}
            {{ raw[:-2] }}<br>{{ raw[-2:] }}
          {% else %}
            {{ raw }}
          {% endif %}
        </td>
      {% endfor %}
      <td class="ketthuc">{{ summary[user.id]['kl'] }}</td>
      <td class="ketthuc">{{ summary[user.id]['tg'] }}</td>
      <td class="ketthuc">{{ summary[user.id]['100'] }}</td>
      <td class="ketthuc">{{ summary[user.id]['bhxh'] }}</td>
    </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>

<div class="d-none d-print-block" style="width: 100%; font-size: 13px; margin-top: 0.5cm;">
  <div style="display: grid; grid-template-columns: 20% 20% 20% 20% 20%;">
    <div style="text-align: left;">
      <strong>N∆°i nh·∫≠n:</strong><br>
      - Ban Gi√°m ƒë·ªëc<br>
      - C√°c khoa/ph√≤ng<br>
      - ƒêƒÉng website<br>
      - L∆∞u: VP, KH-CNTT
    </div>
    <div style="text-align: center;">
      <strong>NG∆Ø·ªúI L·∫¨P B·∫¢NG</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div style="text-align: center;">
      <strong>TR∆Ø·ªûNG KHOA/PH√íNG</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div style="text-align: center;">
      <strong>PH√íNG T·ªî CH·ª®C - HCQT</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div style="text-align: center;">
      <strong>GI√ÅM ƒê·ªêC</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
  </div>
</div>

<script>
document.querySelector("form").addEventListener("submit", function(e) {
  const printChecked = document.getElementById("print_filter").checked;
  const contractType = document.querySelector("select[name='contract_type']").value;
  if (printChecked && !contractType) {
    alert("Vui l√≤ng ch·ªçn lo·∫°i h·ª£p ƒë·ªìng n·∫øu mu·ªën l·ªçc khi in!");
    e.preventDefault();
  }
});
</script>
{% endblock %}
