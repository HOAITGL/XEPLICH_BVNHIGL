{% extends "layout.html" %}

{% block title %}B·∫£ng t·ªïng h·ª£p c√¥ng tr·ª±c{% endblock %}

{% block content %}
{% if unit_config %}
<div class="text-center mb-3">
  <h3 class="mb-0">{{ unit_config.name }}</h3>
  <p class="mb-0">{{ unit_config.address }} - {{ unit_config.phone }}</p>
</div>
{% endif %}

<h4 class="text-center mb-3">üìä B·∫¢NG T·ªîNG H·ª¢P C√îNG TR·ª∞C TH√ÅNG {{ thang }}/{{ nam }}</h4>

<form class="row g-2 mb-3" method="get" action="{{ url_for('tong_hop_cong_truc_view') }}">
  <div class="col-md-3">
    <label class="form-label">Khoa/Ph√≤ng:</label>
    <select name="department" class="form-select">
      <option value="">T·∫•t c·∫£</option>
      {% for dept in departments %}
        <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>{{ dept }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">Ch·∫ø ƒë·ªô:</label>
    <select name="mode" class="form-select">
      <option value="16h" {% if mode == '16h' %}selected{% endif %}>T√≠nh theo gi·ªù 16h</option>
      <option value="24h" {% if mode == '24h' %}selected{% endif %}>T√≠nh theo ca 24h</option>
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">T·ª´ ng√†y:</label>
    <input type="date" class="form-control" name="start_date" value="{{ default_start or '' }}">
  </div>

  <div class="col-md-2">
    <label class="form-label">ƒê·∫øn ng√†y:</label>
    <input type="date" class="form-control" name="end_date" value="{{ default_end or '' }}">
  </div>

  <div class="col-md-3 d-flex align-items-end gap-2">
    <button type="submit" formaction="{{ url_for('tong_hop_cong_truc_print') }}" formtarget="_blank" class="btn btn-primary">üìÑ In b·∫£ng</button>
    <button type="submit" class="btn btn-secondary">üëÅÔ∏è Xem b·∫£ng</button>
    <a href="{{ url_for('export_report_all', start_date=default_start, end_date=default_end, department=selected_department) }}" class="btn btn-success">‚¨áÔ∏è Xu·∫•t Excel</a>
  </div>
</form>

{% if rows %}
<div class="table-responsive">
  <table class="table table-bordered table-sm text-center align-middle">
    <thead class="table-light">
      <tr>
        <th rowspan="2">STT</th>
        <th rowspan="2">H·ªå T√äN</th>
        <th colspan="2">Tr·ª±c ng√†y th∆∞·ªùng</th>
        <th colspan="2">Tr·ª±c ng√†y ngh·ªâ</th>
        <th colspan="2">Tr·ª±c ng√†y l·ªÖ</th>
        <th rowspan="2">T·ªïng s·ªë<br>ng√†y tr·ª±c</th>
        <th rowspan="2">Ghi ch√∫</th>
      </tr>
      <tr>
        <th>Th∆∞·ªùng</th><th>HSCC</th>
        <th>Th∆∞·ªùng</th><th>HSCC</th>
        <th>Th∆∞·ªùng</th><th>HSCC</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ loop.index }}</td>
        <td class="text-start">{{ r.user.name }}</td>
        <td>{{ r.detail.get(('th∆∞·ªùng','ng√†y_th∆∞·ªùng'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.detail.get(('HSCC','ng√†y_th∆∞·ªùng'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.detail.get(('th∆∞·ªùng','ng√†y_ngh·ªâ'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.detail.get(('HSCC','ng√†y_ngh·ªâ'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.detail.get(('th∆∞·ªùng','ng√†y_l·ªÖ'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.detail.get(('HSCC','ng√†y_l·ªÖ'), {}).get('so_ngay', 0) }}</td>
        <td>{{ r.tong_ngay }}</td>
        <td>{{ r.ghi_chu }}</td>
      </tr>
      {% endfor %}
      <tr class="fw-bold">
        <td colspan="2">T·ªïng c·ªông</td>
        <td>{{ sum_row.detail.get(('th∆∞·ªùng','ng√†y_th∆∞·ªùng'), 0) }}</td>
        <td>{{ sum_row.detail.get(('HSCC','ng√†y_th∆∞·ªùng'), 0) }}</td>
        <td>{{ sum_row.detail.get(('th∆∞·ªùng','ng√†y_ngh·ªâ'), 0) }}</td>
        <td>{{ sum_row.detail.get(('HSCC','ng√†y_ngh·ªâ'), 0) }}</td>
        <td>{{ sum_row.detail.get(('th∆∞·ªùng','ng√†y_l·ªÖ'), 0) }}</td>
        <td>{{ sum_row.detail.get(('HSCC','ng√†y_l·ªÖ'), 0) }}</td>
        <td>{{ sum_row.tong_ngay }}</td>
        <td></td>
      </tr>
    </tbody>
  </table>
</div>
{% else %}
<p class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</p>
{% endif %}
{% endblock %}
