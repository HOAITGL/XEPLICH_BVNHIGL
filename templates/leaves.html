{% extends 'layout.html' %}
{% block content %}

<h2 class="mb-3">Danh sÃ¡ch Ä‘Æ¡n nghá»‰ phÃ©p</h2>

{# FLASH: hiá»‡n thÃ´ng bÃ¡o cá»¥ thá»ƒ tá»« route (cÃ²n bao nhiÃªu ngÃ y, Ä‘Ã£ dÃ¹ng bao nhiÃªu, ...) #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, msg in messages %}
        <div class="alert alert-{{ 'danger' if category=='error' else category }} py-2 mb-2">
          {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{# TÃ³m táº¯t phÃ©p nÄƒm cho user hiá»‡n táº¡i (náº¿u backend truyá»n leave_info) #}
{% if leave_info %}
  <div class="alert alert-info d-flex flex-wrap gap-3 align-items-center">
    <div><strong>NÄƒm {{ leave_info.year }}</strong></div>
    <div>ÄÆ°á»£c cáº¥p: <strong>{{ leave_info.total }}</strong> ngÃ y</div>
    <div>ÄÃ£ dÃ¹ng: <strong>{{ leave_info.used }}</strong> ngÃ y</div>
    <div>CÃ²n láº¡i: <strong>{{ leave_info.remaining }}</strong> ngÃ y</div>
  </div>
{% endif %}

{# Hiá»ƒn thá»‹ bá»™ lá»c khoa cho admin/admin1 #}
{% if current_role in ['admin', 'admin1'] %}
<form method="get" class="mb-3 d-flex gap-2 align-items-center">
  <select name="department" class="form-select" style="max-width: 360px">
    <option value="">-- Táº¥t cáº£ khoa --</option>
    {% for d in departments %}
      <option value="{{ d }}" {% if d == selected_department %}selected{% endif %}>{{ d }}</option>
    {% endfor %}
  </select>
  <button class="btn btn-primary">Lá»c</button>
</form>
{% else %}
<p class="text-muted">Khoa cá»§a báº¡n: <strong>{{ current_department }}</strong></p>
{% endif %}

{# NÃºt thÃªm Ä‘Æ¡n (khÃ³a náº¿u háº¿t phÃ©p) #}
{% set can_create = (not leave_info) or (leave_info.remaining|int > 0) %}
{% if can_create %}
  <a href="/leaves/add" class="btn btn-primary mb-3">ThÃªm Ä‘Æ¡n nghá»‰ phÃ©p</a>
{% else %}
  <button class="btn btn-secondary mb-3" disabled title="Báº¡n Ä‘Ã£ dÃ¹ng háº¿t ngÃ y phÃ©p nÄƒm {{ leave_info.year }}.">
    ThÃªm Ä‘Æ¡n nghá»‰ phÃ©p
  </button>
{% endif %}

<table class="table table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Há» tÃªn</th>
      <th>Tá»« ngÃ y</th>
      <th>Äáº¿n ngÃ y</th>
      <th>Sá»‘ ngÃ y</th>
      <th>Tá»•ng phÃ©p nÄƒm</th>  {# âœ… Cá»™t má»›i #}
      <th>LÃ½ do</th>
      <th style="width: 320px">HÃ nh Ä‘á»™ng</th>
      <th style="width: 160px">CÃ²n láº¡i (nÄƒm {{ leave_info.year if leave_info else '' }})</th>
    </tr>
  </thead>
  <tbody>
    {% if leaves and leaves|length > 0 %}
      {% for leave in leaves %}
      {% set b = balances.get(leave.user_id) %}
      <tr>
        <td>{{ leave.user.name }}</td>
        <td>{{ leave.start_date.strftime('%d/%m/%Y') if leave.start_date else 'â€”' }}</td>
        <td>{{ leave.end_date.strftime('%d/%m/%Y') if leave.end_date else 'â€”' }}</td>

        {# Sá»‘ ngÃ y cá»§a Ä‘Æ¡n (náº¿u model Ä‘Ã£ cÃ³ days_off thÃ¬ dÃ¹ng trá»±c tiáº¿p, khÃ´ng thÃ¬ cÃ³ thá»ƒ thay báº±ng cÃ´ng thá»©c trong Jinja) #}
        <td>
          {{ leave.days_off if leave.days_off is not none else ((leave.end_date - leave.start_date).days + 1) if (leave.start_date and leave.end_date) else 'â€”' }}
        </td>

        {# âœ… Tá»•ng sá»‘ ngÃ y phÃ©p/nÄƒm cá»§a nhÃ¢n viÃªn #}
        <td>{{ (b.total ~ ' ngÃ y') if b and b.total is not none else 'â€”' }}</td>

        <td>{{ leave.reason }}</td>

        <td class="d-flex gap-2 flex-wrap">
          {% if current_role in ['admin', 'admin1'] or (user and leave.user_id == user.id) %}
            <a href="/leaves/print/{{ leave.id }}" class="btn btn-sm btn-primary">In Ä‘Æ¡n</a>
            <a href="{{ url_for('export_leave_word', leave_id=leave.id) }}" class="btn btn-sm btn-secondary">Xuáº¥t Word</a>
            <form method="POST" action="/leaves/delete/{{ leave.id }}"
                  onsubmit="return confirm('XoÃ¡ Ä‘Æ¡n nghá»‰ nÃ y?')" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ XoÃ¡</button>
            </form>
          {% else %}
            <span class="text-muted">â€”</span>
          {% endif %}
        </td>

        <td>{{ (b.remaining ~ ' ngÃ y') if b and b.remaining is not none else 'â€”' }}</td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="8" class="text-center text-muted">ChÆ°a cÃ³ Ä‘Æ¡n nghá»‰ phÃ©p nÃ o.</td> {# âœ… cáº­p nháº­t colspan #}
      </tr>
    {% endif %}
  </tbody>
</table>

{% endblock %}
