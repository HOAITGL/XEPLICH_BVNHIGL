{% extends 'layout.html' %}
{% block content %}

<h2 class="mb-3">Danh sách đơn nghỉ phép</h2>

{# Hiển thị bộ lọc khoa cho admin/admin1 #}
{% if current_role in ['admin', 'admin1'] %}
<form method="get" class="mb-3 d-flex gap-2 align-items-center">
  <select name="department" class="form-select" style="max-width: 360px">
    <option value="">-- Tất cả khoa --</option>
    {% for d in departments %}
      <option value="{{ d }}" {% if d == selected_department %}selected{% endif %}>{{ d }}</option>
    {% endfor %}
  </select>
  <button class="btn btn-primary">Lọc</button>
</form>
{% else %}
<p class="text-muted">Khoa của bạn: <strong>{{ current_department }}</strong></p>
{% endif %}

<a href="/leaves/add" class="btn btn-primary mb-3">Thêm đơn nghỉ phép</a>

<table class="table table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Họ tên</th>
      <th>Từ ngày</th>
      <th>Đến ngày</th>
      <th>Lý do</th>
      <th style="width: 260px">Hành động</th>
    </tr>
  </thead>
  <tbody>
    {% if leaves and leaves|length > 0 %}
      {% for leave in leaves %}
      <tr>
        <td>{{ leave.user.name }}</td>
        <td>
          {% if leave.start_date %}
            {{ leave.start_date.strftime('%d/%m/%Y') }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>
          {% if leave.end_date %}
            {{ leave.end_date.strftime('%d/%m/%Y') }}
          {% else %}
            —
          {% endif %}
        </td>
        <td>{{ leave.reason }}</td>
        <td class="d-flex gap-2 flex-wrap">
          {# Chỉ admin/admin1 hoặc CHÍNH CHỦ đơn mới thấy các nút tác vụ #}
          {% if current_role in ['admin', 'admin1'] or (user and leave.user_id == user.id) %}
            <a href="/leaves/print/{{ leave.id }}" class="btn btn-sm btn-primary">In đơn</a>
            <a href="{{ url_for('export_leave_word', leave_id=leave.id) }}" class="btn btn-sm btn-secondary">Xuất Word</a>
            <a href="/leaves/delete/{{ leave.id }}"
               onclick="return confirm('Xoá đơn nghỉ này?')"
               class="btn btn-sm btn-danger">🗑 Xoá</a>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted">Chưa có đơn nghỉ phép nào.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

{% endblock %}
