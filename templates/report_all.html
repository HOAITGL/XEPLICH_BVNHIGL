{% extends 'layout.html' %}
{% block title %}T·ªïng h·ª£p l·ªãch tr·ª±c to√†n vi·ªán{% endblock %}

{% block content %}

<!-- TI√äU ƒê·ªÄ CHU·∫®N C√îNG VƒÇN KHI IN -->
<div class="d-none d-print-block text-center mb-3">
  <div class="row">
    <div class="col-6 text-center">
      <div style="font-weight:bold;">B·ªÜNH VI·ªÜN NHI T·ªàNH GIA LAI</div>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-weight: bold; border-bottom: 1px solid black;">
          PH√íNG KHTH - CNTT
        </span>
      </div>
    </div>
    <div class="col-6 text-center">
      <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-style: bold; border-bottom: 1px solid black;">
          ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c
        </span>
      </div>
      <div style="margin-top: 4px;" class="fst-italic">
        Gia Lai, ng√†y {{ start_date.strftime('%d') }} th√°ng {{ start_date.strftime('%m') }} nƒÉm {{ start_date.strftime('%Y') }}
      </div>
    </div>
  </div>
</div>

<!-- TI√äU ƒê·ªÄ -->
<div class="text-center mb-3 d-print-block">
  <h5><strong>B·∫¢NG PH√ÇN TR·ª∞C TU·∫¶N</strong></h5>
  <p>T·ª´ ng√†y {{ start_date.strftime('%d/%m/%Y') }} ƒë·∫øn {{ end_date.strftime('%d/%m/%Y') }}</p>
</div>

<!-- FORM -->
<form method="get" class="d-flex gap-3 mb-3 d-print-none">
  <div>
    <label class="form-label mb-0">T·ª´ ng√†y:</label>
    <input type="date" name="start" class="form-control" value="{{ start_date }}">
  </div>
  <div>
    <label class="form-label mb-0">ƒê·∫øn ng√†y:</label>
    <input type="date" name="end" class="form-control" value="{{ end_date }}">
  </div>
  <button type="submit" class="btn btn-primary">L·ªçc</button>
  <a href="/export-report-all?start={{ start_date }}&end={{ end_date }}" class="btn btn-success">üì• Xu·∫•t Excel</a>
  <button type="button" class="btn btn-secondary" onclick="window.print()">üñ® In L·ªãch Tr·ª±c</button>
</form>

<!-- B·∫¢NG -->
<style>
.table-scroll {
  overflow: visible !important;
  height: auto !important;
}
.table-scroll thead th {
  position: sticky;
  top: 0;
  background-color: #212529;
  color: white;
  z-index: 2;
}
</style>

<div class="table-scroll">
<table class="table table-bordered text-center">
  <thead class="table-dark">
    <tr>
      <th>STT</th>
      <th>Khoa/Ph√≤ng</th>
      <th>C·∫•p b·∫≠c/ ch·ª©c v·ª•</th>
      {% for d in date_range %}
        <th>{{ d.strftime('%a %d/%m') }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% set grouped_by_dept = {} %}
    {% for (dept, pos), days in grouped.items() %}
      {% if dept not in grouped_by_dept %}
        {% set _ = grouped_by_dept.update({dept: []}) %}
      {% endif %}
      {% set _ = grouped_by_dept[dept].append((pos, days)) %}
    {% endfor %}

    {% for dept, entries in grouped_by_dept.items() %}
      {% set rowspan = entries | length %}
      {% set stt = loop.index %}
      {% for i in range(rowspan) %}
        <tr>
          {% if i == 0 %}
            <td rowspan="{{ rowspan }}">{{ stt }}</td>
            <td rowspan="{{ rowspan }}"><strong>{{ dept }}</strong></td>
          {% endif %}
          <td>{{ entries[i][0] }}</td>
          {% for d in date_range %}
            {% set key = d.strftime('%a %d/%m') %}
            <td>
              {% set raw = entries[i][1].get(key, '') %}
              {% for line in raw.split('\n') %}
                {% if 'Tr·ª±c' in line %}
                  {{ line }}<br>
                {% endif %}
              {% endfor %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    {% endfor %}
    {% if grouped|length == 0 %}
    <tr><td colspan="{{ date_range|length + 3 }}">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.</td></tr>
    {% endif %}
  </tbody>
</table>
</div>

<!-- CH√ÇN TRANG IN NGAY SAU B·∫¢NG -->
<div class="d-none d-print-block mt-2" style="margin-top: 8px;">
  <div class="row">
    <div class="col-4">
      <strong>N∆°i nh·∫≠n:</strong><br>
      - Ban Gi√°m ƒë·ªëc<br>
      - C√°c khoa/ph√≤ng<br>
      - ƒêƒÉng website<br>
      - L∆∞u: VP, KH-CNTT
    </div>
    <div class="col-4 text-center">
      <strong>NG∆Ø·ªúI L·∫¨P B·∫¢NG</strong><br>
      <em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div class="col-4 text-center">
      <strong>GI√ÅM ƒê·ªêC</strong><br>
      <em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
  </div>
</div>

<!-- CSS IN ·∫§N -->
<style>
@media print {
  .d-print-block { display: block !important; }
  .d-print-none, .btn, .sidebar, form, nav, .print-hide, .user-greeting {
    display: none !important;
  }

  html, body {
    zoom: 100%;
    margin: 0 !important;
    padding: 0 !important;
    width: 100%;
    height: 100%;
  }

  .container, .row, .main, .wrapper, .content {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  table {
    width: 100% !important;
    table-layout: auto;
    border-collapse: collapse;
    font-size: 13px;
  }

  th, td {
    padding: 6px;
    border: 1px solid black;
    text-align: center;
    vertical-align: top;
    line-height: 1.3;
    height: 60px;
    word-break: break-word;
  }

  .fst-italic {
    font-style: italic;
  }
}

@page {
  size: A4 landscape;
  margin: 1cm 1cm 1cm 2cm;
}
</style>

{% endblock %}
