<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thi·∫øt l·∫≠p m·ª©c ƒë·ªôc h·∫°i</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-4">Thi·∫øt l·∫≠p m·ª©c ƒë·ªôc h·∫°i</h2>
    <a href="/" class="btn btn-secondary">üè† V·ªÅ trang ch·ªß</a>
  </div>

  <form method="post" class="row g-3 border p-3 mb-4 rounded" autocomplete="off">
    <!-- Khoa -->
    <div class="col-md-4">
      <label for="departments" class="form-label">Khoa/Ph√≤ng</label>
      <select name="departments" id="departments" class="form-select" multiple required>
        {% for d in departments %}
          <option value="{{ d.name }}" data-is-lab="{{ 1 if d.is_lab else 0 }}">{{ d.name }}</option>
        {% endfor %}
      </select>
      <small class="text-muted">Nh·∫•n Ctrl (ho·∫∑c Cmd tr√™n Mac) ƒë·ªÉ ch·ªçn nhi·ªÅu khoa</small>
    </div>

    <!-- Ch·ª©c v·ª• -->
    <div class="col-md-2">
      <label for="position" class="form-label">Ch·ª©c v·ª• (n·∫øu √°p d·ª•ng)</label>
      <input type="text" name="position" class="form-control" placeholder="VD: HL, KTV" />
    </div>

    <!-- Lo·∫°i m√°y -->
    <div class="col-md-2" id="machine-type-group">
      <label for="machine_type" class="form-label">Lo·∫°i m√°y</label>
      <select name="machine_type" class="form-select">
        <option value="">T·∫•t c·∫£ m√°y</option>
        <option value="M√°y huy·∫øt h·ªçc">M√°y huy·∫øt h·ªçc</option>
        <option value="M√°y truy·ªÅn m√°u">M√°y truy·ªÅn m√°u</option>
        <option value="M√°y vi sinh">M√°y vi sinh</option>
      </select>
      <small class="text-muted">Ch·ªâ √°p d·ª•ng khi ch·ªçn khoa x√©t nghi·ªám.</small>
    </div>

    <!-- M·ª©c ƒë·ªôc h·∫°i -->
    <div class="col-md-2">
      <label for="hazard_level" class="form-label">M·ª©c ƒë·ªôc h·∫°i</label>
      <input type="number" step="0.01" name="hazard_level" class="form-control" placeholder="VD: 0.3" required />
    </div>

    <!-- ƒê∆°n v·ªã -->
    <div class="col-md-2">
      <label for="unit" class="form-label">ƒê∆°n v·ªã</label>
      <select name="unit" class="form-select" required>
        <option value="%">%</option>
        <option value="ngay">Ng√†y</option>
        <option value="gio">Gi·ªù</option>
      </select>
    </div>

    <!-- S·ªë gi·ªù -->
    <div class="col-md-2">
      <label for="duration_hours" class="form-label">S·ªë gi·ªù t√≠nh</label>
      <input type="number" step="0.5" min="0" name="duration_hours" class="form-control" required />
    </div>

    <!-- √Åp d·ª•ng ri√™ng cho T7/CN -->
    <div class="col-md-3">
      <label class="form-label">T√πy ch·ªçn Th·ª© 7/CN</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="weekend_only" id="weekend_only">
        <label class="form-check-label" for="weekend_only">√Åp d·ª•ng ri√™ng cho Th·ª© 7/CN</label>
      </div>
      <div id="weekend_part_wrap" style="display:none; margin-top:8px;">
        <select name="weekend_part" id="weekend_part" class="form-select">
          <option value="full">C·∫£ ng√†y (17h)</option>
          <option value="half">N·ª≠a ng√†y (7h)</option>
        </select>
      </div>
    </div>

    <!-- Ng√†y √°p d·ª•ng -->
    <div class="col-md-3">
      <label class="form-label">T·ª´ ng√†y</label>
      <input type="date" name="start_date" class="form-control" required />
    </div>
    <div class="col-md-3">
      <label class="form-label">ƒê·∫øn ng√†y</label>
      <input type="date" name="end_date" class="form-control" required />
    </div>

    <!-- N√∫t l∆∞u -->
    <div class="col-12">
      <button type="submit" class="btn btn-primary">L∆∞u c·∫•u h√¨nh</button>
    </div>
  </form>

  <h4>Danh s√°ch c·∫•u h√¨nh</h4>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Khoa</th>
        <th>Ch·ª©c v·ª•</th>
        <th>Lo·∫°i m√°y</th>
        <th>M·ª©c %</th>
        <th>ƒê∆°n v·ªã</th>
        <th>S·ªë gi·ªù</th>
        <th>Th·ªùi gian √°p d·ª•ng</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      {% set unit_label = {'%':'%', 'ƒë':'ƒë', 'gio':'gi·ªù', 'ngay':'ng√†y'} %}
      {% for c in configs %}
      <tr>
        <td>{{ c.department }}</td>
        <td>{{ c.position or 'T·∫•t c·∫£' }}</td>
        <td>{{ c.machine_type or 'T·∫•t c·∫£ m√°y' }}</td>
        <td>{{ c.hazard_level }}</td>
        <td>{{ unit_label.get(c.unit, c.unit) }}</td>
        <td>{{ c.duration_hours }}</td>
        <td>{{ c.start_date.strftime('%d/%m/%Y') }} ‚Üí {{ c.end_date.strftime('%d/%m/%Y') }}</td>
        <td>
          <a href="{{ url_for('edit_hazard_config', config_id=c.id) }}" class="btn btn-sm btn-warning">S·ª≠a</a>
          <a href="{{ url_for('delete_hazard_config', config_id=c.id) }}"
             class="btn btn-danger btn-sm"
             onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c·∫•u h√¨nh n√†y?')">X√≥a</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const deptSelect = document.getElementById('departments');
      const machineTypeContainer = document.getElementById('machine-type-group');
      const machineTypeSelect = document.querySelector('select[name="machine_type"]');

      function toggleMachineType() {
        const isLab = Array.from(deptSelect.selectedOptions)
          .some(opt => opt.dataset.isLab === "1");
        if (isLab) {
          machineTypeContainer.style.display = "";
        } else {
          machineTypeContainer.style.display = "none";
          machineTypeSelect.value = "";
        }
      }
      deptSelect.addEventListener('change', toggleMachineType);
      toggleMachineType();

      // X·ª≠ l√Ω hi·ªÉn th·ªã ph·∫ßn t√πy ch·ªçn T7/CN
      const weekendOnly = document.getElementById('weekend_only');
      const weekendPartWrap = document.getElementById('weekend_part_wrap');
      const weekendPart = document.getElementById('weekend_part');
      const unitSelect = document.querySelector('[name="unit"]');
      const hoursInput = document.querySelector('[name="duration_hours"]');

      function syncWeekendUI() {
        if (weekendOnly.checked) {
          weekendPartWrap.style.display = 'block';
          if (unitSelect) unitSelect.value = 'gio';
          if (hoursInput) hoursInput.value = (weekendPart.value === 'full') ? '17' : '7';
        } else {
          weekendPartWrap.style.display = 'none';
        }
      }
      weekendOnly?.addEventListener('change', syncWeekendUI);
      weekendPart?.addEventListener('change', syncWeekendUI);
    });
  </script>
</body>
</html>
