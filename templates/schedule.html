{% extends 'layout.html' %}
{% block title %}Lá»‹ch trá»±c theo khoa{% endblock %}
{% block content %}

{% if user and user.name %}
  <p class="user-greeting d-print-none">Xin chÃ o {{ user.name }} ({{ user.role }})</p>
{% endif %}


<!-- ThÃ´ng bÃ¡o flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="ÄÃ³ng"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- TIÃŠU Äá»€ CHUáº¨N CÃ”NG VÄ‚N -->
<div class="d-none d-print-block text-center mb-3">
  <div class="row">
    <div class="col-6 text-start">
      <strong>Bá»†NH VIá»†N NHI Tá»ˆNH GIA LAI</strong><br>
      {% if selected_department %}
      <span style="display:inline-block; font-weight:bold; border-bottom:1px solid black; margin-left:25px;">
        {{ selected_department.upper() }}
      </span>
      {% endif %}
    </div>
    <div class="col-6 text-center">
      <strong>Cá»˜NG HÃ’A XÃƒ Há»˜I CHá»¦ NGHÄ¨A VIá»†T NAM</strong><br>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-style: italic; border-bottom: 1px solid black;">
          Äá»™c láº­p - Tá»± do - Háº¡nh phÃºc
        </span>
      </div>
      {% if now %}
      <div style="margin-top: 4px;">
        Gia Lai, ngÃ y {{ now.strftime('%d') }} thÃ¡ng {{ now.strftime('%m') }} nÄƒm {{ now.strftime('%Y') }}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<h5 class="text-center">
  Báº¢NG Lá»ŠCH TRá»°C {{ selected_department.upper() if selected_department else "" }}
</h5>
<p class="text-center">
  Lá»‹ch trá»±c tuáº§n ngÃ y {{ start_date.strftime('%d/%m/%Y') }} Ä‘áº¿n ngÃ y {{ end_date.strftime('%d/%m/%Y') }}
</p>

<div class="container-fluid px-0">
  <form method="GET" class="row g-2 align-items-end">
    <div class="col-md-3">
      <label for="department" class="form-label mb-0">Khoa:</label>
      <select name="department" id="department" class="form-select">
        <option value="">-- Táº¥t cáº£ --</option>
        {% for dept in departments %}
          <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label for="start_date" class="form-label mb-0">Tá»« ngÃ y:</label>
      <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
    </div>
    <div class="col-md-2">
      <label for="end_date" class="form-label mb-0">Äáº¿n ngÃ y:</label>
      <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Lá»c</button>
    </div>
  </form>
</div>

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary" onclick="window.print()">ğŸ–¨ In lá»‹ch trá»±c</button>
    <form method="POST" action="/export-template">
      <input type="hidden" name="department" value="{{ selected_department }}">
      <input type="hidden" name="start_date" value="{{ start_date }}">
      <input type="hidden" name="end_date" value="{{ end_date }}">
      <button type="submit" class="btn btn-outline-success">ğŸ“¥ Xuáº¥t Excel theo máº«u</button>
      <a href="/print-clinic-schedule?start={{ start_date }}&end={{ end_date }}" class="btn btn-outline-primary" target="_blank">ğŸ–¨ In phÃ¢n lá»‹ch phÃ²ng khÃ¡m</a>
    </form>
  </div>
  <div>
    {% if not is_signed and user.role == 'manager' %}
      <!-- Chá»‰ manager má»›i Ä‘Æ°á»£c kÃ½ xÃ¡c nháº­n -->
      <form method="POST" action="/schedule/sign"
          onsubmit="return confirm('XÃ¡c nháº­n kÃ½ vÃ  khÃ³a báº£ng lá»‹ch trá»±c?');">
        <input type="hidden" name="department" value="{{ selected_department }}">
        <input type="hidden" name="from_date" value="{{ start_date }}">
        <input type="hidden" name="to_date" value="{{ end_date }}">
        <button class="btn btn-warning">ğŸ” KÃ½ xÃ¡c nháº­n</button>
      </form>
    {% elif is_signed %}
      <div class="d-flex gap-2 align-items-center">
        {% if signed_at %}
          <span class="text-success">âœ… ÄÃ£ kÃ½ lÃºc {{ signed_at.strftime('%H:%M %d/%m/%Y') }}</span>
        {% else %}
          <span class="text-success">âœ… ÄÃ£ kÃ½</span>
        {% endif %}
        {% if user.role == 'admin' %}
          <!-- Chá»‰ admin Ä‘Æ°á»£c há»§y kÃ½ -->
          <form method="POST" action="/schedule/unlock"
                onsubmit="return confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n há»§y kÃ½ vÃ  má»Ÿ khÃ³a lá»‹ch trá»±c?');">
            <input type="hidden" name="department" value="{{ selected_department }}">
            <input type="hidden" name="from_date" value="{{ start_date }}">
            <input type="hidden" name="to_date" value="{{ end_date }}">
            <button class="btn btn-sm btn-danger">âŒ Há»§y kÃ½</button>
          </form>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<style>
.table-scroll {
  max-height: 550px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
}
.table-scroll thead th {
  position: sticky;
  top: 0;
  background-color: #212529;
  color: white;
  z-index: 2;
}
</style>

<div class="table-scroll">
<table class="table table-bordered table-striped">
  <thead class="table-dark">
    <tr>
      <th>Há» tÃªn</th>
      <th>Cáº¥p báº­c/ chá»©c vu</th>
      <th>Khoa</th>
      {% for d in date_range %}
        <th>{{ d.strftime('%d/%m') }}</th>
      {% endfor %}
      <th class="print-hide">Thao tÃ¡c</th>
    </tr>
  </thead>
  <tbody>
    {% for u in schedule_data.values() %}
    <tr class="user-row">
      <td>{{ u.name }}</td>
      <td>{{ u.position }}</td>
      <td>{{ u.department }}</td>
      {% for d in date_range %}
      {% set ca = u.shifts_full.get(d) %}
      <td class="{% if ca and not ca.shift_name.startswith('Trá»±c') %}non-duty{% endif %}">
        {% if ca %}
          {{ ca.shift_name }}
          {% if user.role == 'admin' or (user.role == 'manager' and not locked and not is_signed) %}
          <form method="POST" action="/schedule/delete-one"
                onsubmit="return confirm('XoÃ¡ ca trá»±c ngÃ y {{ d.strftime('%d/%m') }}?')"
                style="display:inline;">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <input type="hidden" name="shift_id" value="{{ ca.shift_id }}">
            <input type="hidden" name="work_date" value="{{ d.strftime('%Y-%m-%d') }}">
            <button type="submit" class="btn btn-sm btn-outline-danger px-1 py-0" style="font-size: 0.75rem;">ğŸ—‘</button>
          </form>
          {% endif %}
        {% endif %}
      </td>
      {% endfor %}
      <td class="print-hide">
        {% if user.role == 'admin' or (user.role == 'manager' and not locked and not is_signed) %}
          <a href="/schedule/edit/{{ u.id }}" class="btn btn-sm btn-primary">Sá»­a</a>
        {% else %}
          <span class="text-muted">ÄÃ£ khÃ³a</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
  </table>
</div>

<!-- CHÃ‚N IN -->
<div class="d-none d-print-block" style="margin-top: 6px;">
  <div class="row">
    <div class="col-3">
      <strong>NÆ¡i nháº­n:</strong><br>
      - Ban GiÃ¡m Ä‘á»‘c<br>
      - CÃ¡c khoa/phÃ²ng<br>
      - ÄÄƒng website<br>
      - LÆ°u: VP, KH-CNTT
    </div>
    <div class="col-3 text-center">
      <strong>NgÆ°á»i láº­p báº£ng</strong><br>
      <em>(KÃ½, ghi rÃµ há» tÃªn)</em>
    </div>
    <div class="col-3 text-center">
      <strong>
        {% if selected_department and 'khoa' in selected_department.lower() %}
        TRÆ¯á»NG KHOA
        {% else %}
        TRÆ¯á»NG PHÃ’NG
        {% endif %}
      </strong>
    </div>
    <div class="col-3 text-center">
      <strong>GIÃM Äá»C</strong><br>
      <em>(KÃ½, ghi rÃµ há» tÃªn)</em>
    </div>
  </div>
</div>

<style>
@media print {
  .d-print-block { display: block !important; }
  .d-print-none, .btn, .sidebar, form, nav, .print-hide, .user-greeting {
    display: none !important;
  }
  html, body {
    zoom: 100%;
    margin: 0 !important;
    padding: 0 !important;
    width: 100%;
    height: 100%;
  }
  .container, .row, .main, .wrapper, .content {
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  .table-scroll {
    max-height: none !important;
    overflow: visible !important;
    height: auto !important;
  }
  .table-scroll::-webkit-scrollbar {
    display: none;
  }
  table {
    width: 100% !important;
    table-layout: fixed;
    border-collapse: collapse;
    font-size: 13px;
  }
  th, td {
    word-wrap: break-word;
    padding: 6px;
    border: 1px solid black;
    text-align: center;
  }
  .non-duty {
    display: none !important;
  }
}
@page {
  size: A4 landscape;
  margin: 1cm 1cm 1cm 2cm;
}
</style>

{% endblock %}
