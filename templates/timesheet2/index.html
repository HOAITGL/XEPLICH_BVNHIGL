{% extends "layout.html" %}
{% block title %}Bảng chấm công BHYT{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Bảng chấm công BHYT</h4>
  </div>

  <div class="row g-3 mb-4">
    <!-- Chỉ giữ lại nhóm Sao chép từ lịch -->
    <div class="col-12">
      <div class="card"><div class="card-body">
        <h6 class="card-title">Sao chép từ lịch (Schedule)</h6>
        <form method="post" action="/timesheet2/create-from-schedule" class="row g-2">
          <div class="col-md-6 col-lg-4">
            <label class="form-label">Tên bảng</label>
            <input type="text" name="name" class="form-control" placeholder="Bảng chấm công BHYT (sao chép)">
          </div>
          <div class="col-md-6 col-lg-4">
            <label class="form-label">Khoa/Phòng</label>
            <select name="department" class="form-select" required>
              {% for d in departments %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-6 col-lg-2">
            <label class="form-label">Từ ngày</label>
            <input type="date" name="start_date" class="form-control" required>
          </div>
          <div class="col-md-6 col-lg-2">
            <label class="form-label">Đến ngày</label>
            <input type="date" name="end_date" class="form-control" required>
          </div>
          <div class="col-12">
            <button class="btn btn-success">Sao chép</button>
          </div>
        </form>
      </div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table table-bordered table-striped align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Tên</th><th>Khoa</th><th>Khoảng ngày</th><th>Thao tác</th>
          </tr>
        </thead>
        <tbody id="ts2-tbody">
          {% for s in sheets %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.department }}</td>
            <td>{{ s.start_date }} → {{ s.end_date }}</td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-primary me-1" href="/timesheet2/{{ s.id }}">Mở</a>
              <button type="button" class="btn btn-sm btn-danger btn-delete" data-id="{{ s.id }}">Xóa</button>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center text-muted">Chưa có bảng chấm công nào.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- JS: xử lý nút Xóa -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const tbody = document.getElementById('ts2-tbody');

  tbody.querySelectorAll(".btn-delete").forEach(btn => {
    btn.addEventListener("click", async function() {
      const id = this.dataset.id;
      if (!confirm("Bạn có chắc chắn muốn xóa bảng #" + id + " không?")) return;

      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = "Đang xóa...";

      try {
        const res = await fetch(`/timesheet2/${id}/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        const d = await res.json();
        if (d.ok) {
          const tr = this.closest("tr");
          if (tr) tr.remove();
          if (!tbody.querySelector("tr")) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="5" class="text-center text-muted">Chưa có bảng chấm công nào.</td>`;
            tbody.appendChild(row);
          }
        } else {
          alert(d.msg || "Không xoá được.");
          this.disabled = false;
          this.textContent = originalText;
        }
      } catch (err) {
        alert("Lỗi: " + err);
        this.disabled = false;
        this.textContent = originalText;
      }
    });
  });
});
</script>
{% endblock %}
