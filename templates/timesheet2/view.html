{% extends "layout.html" %}
{% block title %}{{ sheet.name }}{% endblock %}
{% block content %}
{% set thang = sheet.start_date.strftime('%m') %}
{% set nam   = sheet.start_date.strftime('%Y') %}
{% set hospital = (hospital_name if hospital_name is defined and hospital_name else 'B·ªÜNH VI·ªÜN NHI T·ªàNH GIA LAI') %}
{% set dept_upper = (sheet.department or '') %}

<style>
  /* M√†u T7/CN/L·ªÖ */
  th.col-holiday, td.col-holiday { background: #fff4c2 !important; }
  th.col-sat,     td.col-sat     { background: #e8f1ff !important; }
  th.col-sun,     td.col-sun     { background: #ffe8e8 !important; }

  /* 4 c·ªôt T·ªïng h·ª£p n·ªÅn xanh gi·ªëng b·∫£ng ch√≠nh */
  th.summary-head { background: #d7ead2 !important; }
  td.summary-col  { background: #f1f7ef !important; }

  .cell-box { min-height: 46px; white-space: pre-line; }
  td[contenteditable="true"] { outline: none; }

  /* ====== C·ªê ƒê·ªäNH 3 C·ªòT TR√ÅI (STT, H·ªç t√™n, Ch·ª©c v·ª•) ====== */
  .table-container{
    max-height:72vh; overflow:auto; position:relative;
    --hdr1:44px; --hdr2:48px; --hdr3:42px;
  }

  /* ƒë·ªô r·ªông chu·∫©n cho 3 c·ªôt tr√°i */
  :root{
    --w-stt: 64px;          /* STT */
    --w-name: 240px;        /* H·ªç v√† t√™n */
    --w-pos: 120px;         /* C·∫•p b·∫≠c/ch·ª©c v·ª• */
  }

  /* width c·ªë ƒë·ªãnh */
  th.col-stt,  td.col-stt  { width:var(--w-stt);  min-width:var(--w-stt);  max-width:var(--w-stt);  }
  th.col-name, td.col-name { width:var(--w-name); min-width:var(--w-name); max-width:var(--w-name); white-space:nowrap; }
  th.col-pos,  td.col-pos  { width:var(--w-pos);  min-width:var(--w-pos);  max-width:var(--w-pos);  white-space:pre-line; }

  /* sticky 3 c·ªôt tr√°i */
  .sticky-col{ position:sticky; left:0; background:#fff; background-clip:padding-box; z-index:7; box-shadow: 1px 0 0 rgba(0,0,0,.08); }
  th.sticky-col{ z-index:8; }
  .col-stt.sticky-col{ left:0; }
  .col-name.sticky-col{ left:var(--w-stt); }
  .col-pos.sticky-col{ left:calc(var(--w-stt) + var(--w-name)); }

  /* Header 3 t·∫ßng d√≠nh tr√™n */
  .hdr-1 th, .hdr-2 th, .hdr-3 th{ position:sticky; background:#fff; background-clip:padding-box; z-index:6; }
  .hdr-1 th{ top:0; z-index:9; }
  .hdr-2 th{ top:var(--hdr1); z-index:8; }
  .hdr-3 th{ top:calc(var(--hdr1) + var(--hdr2)); z-index:7; }

  /* gi·ªØ m√†u c·ªßa ng√†y ƒë·∫∑c bi·ªát tr√™n header sticky */
  .hdr-1 th.col-holiday, .hdr-2 th.col-holiday, .hdr-3 th.col-holiday { background:#fff4c2 !important; }
  .hdr-1 th.col-sat,     .hdr-2 th.col-sat,     .hdr-3 th.col-sat     { background:#e8f1ff !important; }
  .hdr-1 th.col-sun,     .hdr-2 th.col-sun,     .hdr-3 th.col-sun     { background:#ffe8e8 !important; }

  .print-only{ display:none; } .screen-only{ display:block; }

  /* In A4 n·∫±m ngang */
  @media print {
    @page { size: A4 landscape; margin: 10mm; }
    .screen-only, .btn, .alert, .breadcrumb,
    .d-flex.mb-2 > div > a, .d-flex.mb-2 > div > button,
    .sidebar, .navbar { display:none !important; }
    .print-only{ display:block !important; }
    .table-container{ max-height:none !important; overflow:visible !important; }
    /* t·∫Øt sticky khi in */
    .hdr-1 th, .hdr-2 th, .hdr-3 th, .sticky-col{ position:static !important; box-shadow:none !important; }
    thead{ display: table-header-group; }
    table.table, .table th, .table td{ border:1px solid #000 !important; }
    .table{ font-size: 11px; }
    th, td{ padding:2px 3px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }

  .print-header{ text-align:center; margin-bottom:8px; font-size:13px; line-height:1.25; }
  .print-header .row-top{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2px; }
  .print-header .left{ text-align:left; font-weight:700; text-transform:uppercase; }
  .print-header .left small{ font-weight:400; text-transform:none; }
  .print-header .right{ text-align:right; }
  .print-header .right .qg{ font-weight:700; }
  .print-header .right .motto{ font-style:italic; }
  .print-title{ font-weight:700; text-transform:uppercase; margin:4px 0 6px; font-size:14px; }
  .print-sub{ font-size:12px; margin-top:2px; }

  .sign-grid{ width:100%; display:grid; grid-template-columns:repeat(4,1fr); gap:6px; text-align:center; margin-top:6px; font-size:12px; page-break-inside:avoid; }
  .sign-grid .box{ min-height:70px; }
  .sign-grid .u{ font-weight:700; text-transform:uppercase; }
  .sign-grid .i{ font-style:italic; }
</style>

<div class="container-fluid">
  <!-- Thanh c√¥ng c·ª• -->
  <div class="d-flex justify-content-between align-items-center mb-2 screen-only">
    <h5 class="mb-0">{{ sheet.name }} ‚Äî {{ sheet.department }} ({{ sheet.start_date }} ‚Üí {{ sheet.end_date }})</h5>
    <div class="d-flex align-items-center gap-2">
      <form class="d-flex align-items-center gap-2" method="get" action="/timesheet2/{{ sheet.id }}">
        <label class="me-1">Lo·∫°i h·ª£p ƒë·ªìng:</label>
        <select name="contract_type" class="form-select form-select-sm" onchange="this.form.submit()">
          {% for val, text in contract_options %}
            <option value="{{ val }}" {{ 'selected' if val==contract_type else '' }}>{{ text }}</option>
          {% endfor %}
        </select>
      </form>

      <!-- ‚≠ê N√∫t Xem l·∫°i -->
      <button id="btnReload" class="btn btn-outline-secondary btn-sm" type="button">üîÑ Xem l·∫°i</button>

      <a class="btn btn-outline-secondary btn-sm" href="/timesheet2">Danh s√°ch</a>
      <a class="btn btn-secondary btn-sm"
   	  href="/timesheet2/{{ sheet.id }}/print{% if request.args.get('contract_type') %}?contract_type={{ request.args.get('contract_type') }}{% endif %}">
  	In b·∫£ng ch·∫•m c√¥ng
      </a>
      <a class="btn btn-primary btn-sm" href="/timesheet2/{{ sheet.id }}/export">Xu·∫•t Excel</a>
    </div>
  </div>

  <!-- Header in -->
  <div class="print-header print-only">
    <div class="row-top">
      <div class="left">
        {{ hospital }}<br><small>{{ dept_upper }}</small>
      </div>
      <div class="right">
        <div class="qg">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
        <div class="motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div>
        <div class="print-sub">Gia Lai, ng√†y {{ sheet.end_date.strftime('%d') }} th√°ng {{ sheet.end_date.strftime('%m') }} nƒÉm {{ sheet.end_date.strftime('%Y') }}</div>
      </div>
    </div>
    <div class="print-title">B·∫¢NG CH·∫§M C√îNG TH√ÅNG {{ thang }} NƒÇM {{ nam }}</div>
  </div>

  <div class="table-responsive table-container">
    <table class="table table-bordered table-sm align-middle">
      <thead>
        <!-- H√†ng 1 -->
        <tr class="table-warning hdr-1">
          <th colspan="3" class="text-center sticky-col col-stt" style="left:0;">{{ contract_header_text }}</th>
          <th colspan="{{ days|length }}" class="text-center">NG√ÄY TRONG TH√ÅNG</th>
          <th colspan="4" class="text-center">T·ªïng h·ª£p</th>
        </tr>
        <!-- H√†ng 2 -->
        <tr class="table-light hdr-2">
          <th class="col-stt sticky-col text-center">STT</th>
          <th class="col-name sticky-col">H·ªç v√† t√™n</th>
          <th class="col-pos  sticky-col">C·∫•p b·∫≠c/ ch·ª©c v·ª•</th>
          {% for d in days %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <th class="{{ cls }}" style="min-width:48px">{{ d.strftime('%d') }}</th>
          {% endfor %}
          <th class="text-center summary-head" style="min-width:80px">S·ªë c√¥ng<br>kh√¥ng h∆∞·ªüng l∆∞∆°ng</th>
          <th class="text-center summary-head" style="min-width:80px">S·ªë c√¥ng<br>h∆∞·ªüng l∆∞∆°ng TG</th>
          <th class="text-center summary-head" style="min-width:80px">S·ªë c√¥ng<br>ngh·ªâ vi·ªác 100%</th>
          <th class="text-center summary-head" style="min-width:80px">S·ªë c√¥ng<br>BHXH</th>
        </tr>
        <!-- H√†ng 3 -->
        <tr class="table-light hdr-3">
          <th class="col-stt sticky-col"></th>
          <th class="col-name sticky-col"></th>
          <th class="col-pos  sticky-col"></th>
          {% for d in days %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set w = ['T2','T3','T4','T5','T6','T7','CN'][d.weekday()] %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <th class="text-center {{ cls }}">{{ w }}</th>
          {% endfor %}
          <th colspan="4"></th>
        </tr>
      </thead>

      <tbody>
        {% for u in users %}
        <tr class="user-row" data-user="{{ u.id }}">
          <td class="col-stt sticky-col text-center">{{ loop.index }}</td>
          <td class="col-name sticky-col">{{ u.name }}</td>
          <td class="col-pos  sticky-col">{{ u.position or '' }}</td>

          {% for d in days %}
            {% set raw = cell.get((u.id, d)) %}
            {% if raw is iterable and raw is not string %}
              {% set items = raw %}
            {% elif raw %}
              {% set items = [raw] %}
            {% else %}
              {% set items = [] %}
            {% endif %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <td class="{{ cls }}" data-user="{{ u.id }}" data-date="{{ d.strftime('%Y-%m-%d') }}">
              <div class="cell-box" contenteditable="true"
                   onblur="saveCell(this)"
                   onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">
                {%- for e in items -%}
                  {{- e.code -}}{% if not loop.last %}\n{% endif %}
                {%- endfor -%}
              </div>
            </td>
          {% endfor %}

          {% set s = summary_by_user.get(u.id, (0,0,0,0)) %}
          <td class="text-center summary-col">{{ s[0] }}</td>
          <td class="text-center summary-col">{{ s[1] }}</td>
          <td class="text-center summary-col">{{ s[2] }}</td>
          <td class="text-center summary-col">{{ s[3] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ch·ªó k√Ω -->
  <div class="print-only">
    <div class="sign-grid">
      <div class="box"><div class="u">NG∆Ø·ªúI L·∫¨P B·∫¢NG</div><div class="i">(K√Ω, ghi r√µ h·ªç t√™n)</div></div>
      <div class="box"><div class="u">TR∆Ø·ªûNG KHOA</div><div class="i">(K√Ω, ghi r√µ h·ªç t√™n)</div></div>
      <div class="box"><div class="u">PH√íNG T·ªî CH·ª®C - HCQT</div><div class="i">(K√Ω, ghi r√µ h·ªç t√™n)</div></div>
      <div class="box"><div class="u">GI√ÅM ƒê·ªêC</div><div class="i">(K√Ω, ghi r√µ h·ªç t√™n)</div></div>
    </div>
  </div>
</div>

<script>
async function saveCell(div){
  const td = div.closest('td');
  const code = div.innerText.trim();
  const userId = td.dataset.user;
  const work_date = td.dataset.date;

  const res = await fetch('/timesheet2/{{ sheet.id }}/cell', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, work_date, code})
  });
  const j = await res.json();
  if(!j.ok){ alert(j.msg || 'L·ªói c·∫≠p nh·∫≠t'); }
}

/* üîÑ N√∫t Xem l·∫°i: t·∫£i l·∫°i trang ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t */
document.getElementById('btnReload').addEventListener('click', function(){
  // N·∫øu b·∫°n ƒë√£ c√≥ endpoint /timesheet2/<id>/recalc th√¨ c√≥ th·ªÉ g·ªçi tr∆∞·ªõc r·ªìi reload:
  // fetch('/timesheet2/{{ sheet.id }}/recalc', {method:'POST'}).finally(()=>location.reload());
  location.reload();
});

function printTimesheet(){ window.print(); }
</script>
{% endblock %}
