{% extends "layout.html" %}
{% block title %}{{ sheet.name }}{% endblock %}
{% block content %}
{% set thang = sheet.start_date.strftime('%m') %}
{% set nam   = sheet.start_date.strftime('%Y') %}
{% set hospital = (hospital_name if hospital_name is defined and hospital_name else 'BỆNH VIỆN NHI TỈNH GIA LAI') %}
{% set dept_upper = (sheet.department or '') %}

<style>
  /* Màu T7/CN/Lễ */
  th.col-holiday, td.col-holiday { background: #fff4c2 !important; }
  th.col-sat,     td.col-sat     { background: #e8f1ff !important; }
  th.col-sun,     td.col-sun     { background: #ffe8e8 !important; }

  /* 4 cột Tổng hợp nền xanh giống bảng chính */
  th.summary-head { background: #d7ead2 !important; }
  td.summary-col  { background: #f1f7ef !important; }

  .cell-box { min-height: 46px; white-space: pre-line; }
  td[contenteditable="true"] { outline: none; }

  /* ====== CỐ ĐỊNH 3 CỘT TRÁI (STT, Họ tên, Chức vụ) ====== */
  .table-container{
    max-height:72vh; overflow:auto; position:relative;
    --hdr1:44px; --hdr2:48px; --hdr3:42px;
  }

  /* độ rộng chuẩn cho 3 cột trái */
  :root{
    --w-stt: 64px;          /* STT */
    --w-name: 240px;        /* Họ và tên */
    --w-pos: 120px;         /* Cấp bậc/chức vụ */
  }

  /* width cố định */
  th.col-stt,  td.col-stt  { width:var(--w-stt);  min-width:var(--w-stt);  max-width:var(--w-stt);  }
  th.col-name, td.col-name { width:var(--w-name); min-width:var(--w-name); max-width:var(--w-name); white-space:nowrap; }
  th.col-pos,  td.col-pos  { width:var(--w-pos);  min-width:var(--w-pos);  max-width:var(--w-pos);  white-space:pre-line; }

  /* sticky 3 cột trái */
  .sticky-col{ position:sticky; left:0; background:#fff; background-clip:padding-box; z-index:7; box-shadow: 1px 0 0 rgba(0,0,0,.08); }
  th.sticky-col{ z-index:8; }
  .col-stt.sticky-col{ left:0; }
  .col-name.sticky-col{ left:var(--w-stt); }
  .col-pos.sticky-col{ left:calc(var(--w-stt) + var(--w-name)); }

  /* Header 3 tầng dính trên */
  .hdr-1 th, .hdr-2 th, .hdr-3 th{ position:sticky; background:#fff; background-clip:padding-box; z-index:6; }
  .hdr-1 th{ top:0; z-index:9; }
  .hdr-2 th{ top:var(--hdr1); z-index:8; }
  .hdr-3 th{ top:calc(var(--hdr1) + var(--hdr2)); z-index:7; }

  /* giữ màu của ngày đặc biệt trên header sticky */
  .hdr-1 th.col-holiday, .hdr-2 th.col-holiday, .hdr-3 th.col-holiday { background:#fff4c2 !important; }
  .hdr-1 th.col-sat,     .hdr-2 th.col-sat,     .hdr-3 th.col-sat     { background:#e8f1ff !important; }
  .hdr-1 th.col-sun,     .hdr-2 th.col-sun,     .hdr-3 th.col-sun     { background:#ffe8e8 !important; }

  .print-only{ display:none; } .screen-only{ display:block; }

  /* In A4 nằm ngang */
  @media print {
    @page { size: A4 landscape; margin: 10mm; }
    .screen-only, .btn, .alert, .breadcrumb,
    .d-flex.mb-2 > div > a, .d-flex.mb-2 > div > button,
    .sidebar, .navbar { display:none !important; }
    .print-only{ display:block !important; }
    .table-container{ max-height:none !important; overflow:visible !important; }
    /* tắt sticky khi in */
    .hdr-1 th, .hdr-2 th, .hdr-3 th, .sticky-col{ position:static !important; box-shadow:none !important; }
    thead{ display: table-header-group; }
    table.table, .table th, .table td{ border:1px solid #000 !important; }
    .table{ font-size: 11px; }
    th, td{ padding:2px 3px !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }

  .print-header{ text-align:center; margin-bottom:8px; font-size:13px; line-height:1.25; }
  .print-header .row-top{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:2px; }
  .print-header .left{ text-align:left; font-weight:700; text-transform:uppercase; }
  .print-header .left small{ font-weight:400; text-transform:none; }
  .print-header .right{ text-align:right; }
  .print-header .right .qg{ font-weight:700; }
  .print-header .right .motto{ font-style:italic; }
  .print-title{ font-weight:700; text-transform:uppercase; margin:4px 0 6px; font-size:14px; }
  .print-sub{ font-size:12px; margin-top:2px; }

  .sign-grid{ width:100%; display:grid; grid-template-columns:repeat(4,1fr); gap:6px; text-align:center; margin-top:6px; font-size:12px; page-break-inside:avoid; }
  .sign-grid .box{ min-height:70px; }
  .sign-grid .u{ font-weight:700; text-transform:uppercase; }
  .sign-grid .i{ font-style:italic; }
</style>

<div class="container-fluid">
  <!-- Thanh công cụ -->
  <div class="d-flex justify-content-between align-items-center mb-2 screen-only">
    <h5 class="mb-0">{{ sheet.name }} — {{ sheet.department }} ({{ sheet.start_date }} → {{ sheet.end_date }})</h5>
    <div class="d-flex align-items-center gap-2">
      <form class="d-flex align-items-center gap-2" method="get" action="/timesheet2/{{ sheet.id }}">
        <label class="me-1">Loại hợp đồng:</label>
        <select name="contract_type" class="form-select form-select-sm" onchange="this.form.submit()">
          {% for val, text in contract_options %}
            <option value="{{ val }}" {{ 'selected' if val==contract_type else '' }}>{{ text }}</option>
          {% endfor %}
        </select>
      </form>
      <a class="btn btn-outline-secondary btn-sm" href="/timesheet2">Danh sách</a>
      <a class="btn btn-secondary btn-sm"
   	  href="/timesheet2/{{ sheet.id }}/print{% if request.args.get('contract_type') %}?contract_type={{ request.args.get('contract_type') }}{% endif %}">
  	In bảng chấm công
      </a>
      <a class="btn btn-primary btn-sm" href="/timesheet2/{{ sheet.id }}/export">Xuất Excel</a>
    </div>
  </div>

  <!-- Header in -->
  <div class="print-header print-only">
    <div class="row-top">
      <div class="left">
        {{ hospital }}<br><small>{{ dept_upper }}</small>
      </div>
      <div class="right">
        <div class="qg">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
        <div class="motto">Độc lập - Tự do - Hạnh phúc</div>
        <div class="print-sub">Gia Lai, ngày {{ sheet.end_date.strftime('%d') }} tháng {{ sheet.end_date.strftime('%m') }} năm {{ sheet.end_date.strftime('%Y') }}</div>
      </div>
    </div>
    <div class="print-title">BẢNG CHẤM CÔNG THÁNG {{ thang }} NĂM {{ nam }}</div>
  </div>

  <div class="table-responsive table-container">
    <table class="table table-bordered table-sm align-middle">
      <thead>
        <!-- Hàng 1 -->
        <tr class="table-warning hdr-1">
          <th colspan="3" class="text-center sticky-col col-stt" style="left:0;">{{ contract_header_text }}</th>
          <th colspan="{{ days|length }}" class="text-center">NGÀY TRONG THÁNG</th>
          <th colspan="4" class="text-center">Tổng hợp</th>
        </tr>
        <!-- Hàng 2 -->
        <tr class="table-light hdr-2">
          <th class="col-stt sticky-col text-center">STT</th>
          <th class="col-name sticky-col">Họ và tên</th>
          <th class="col-pos  sticky-col">Cấp bậc/ chức vụ</th>
          {% for d in days %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <th class="{{ cls }}" style="min-width:48px">{{ d.strftime('%d') }}</th>
          {% endfor %}
          <th class="text-center summary-head" style="min-width:80px">Số công<br>không hưởng lương</th>
          <th class="text-center summary-head" style="min-width:80px">Số công<br>hưởng lương TG</th>
          <th class="text-center summary-head" style="min-width:80px">Số công<br>nghỉ việc 100%</th>
          <th class="text-center summary-head" style="min-width:80px">Số công<br>BHXH</th>
        </tr>
        <!-- Hàng 3 -->
        <tr class="table-light hdr-3">
          <th class="col-stt sticky-col"></th>
          <th class="col-name sticky-col"></th>
          <th class="col-pos  sticky-col"></th>
          {% for d in days %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set w = ['T2','T3','T4','T5','T6','T7','CN'][d.weekday()] %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <th class="text-center {{ cls }}">{{ w }}</th>
          {% endfor %}
          <th colspan="4"></th>
        </tr>
      </thead>

      <tbody>
        {% for u in users %}
        <tr class="user-row" data-user="{{ u.id }}">
          <td class="col-stt sticky-col text-center">{{ loop.index }}</td>
          <td class="col-name sticky-col">{{ u.name }}</td>
          <td class="col-pos  sticky-col">{{ u.position or '' }}</td>

          {% for d in days %}
            {% set raw = cell.get((u.id, d)) %}
            {% if raw is iterable and raw is not string %}
              {% set items = raw %}
            {% elif raw %}
              {% set items = [raw] %}
            {% else %}
              {% set items = [] %}
            {% endif %}
            {% set dkey = d.strftime('%Y-%m-%d') %}
            {% set cls = 'col-holiday' if dkey in holiday_keys
                         else ('col-sun' if d.weekday()==6 else ('col-sat' if d.weekday()==5 else '') ) %}
            <td class="{{ cls }}" data-user="{{ u.id }}" data-date="{{ d.strftime('%Y-%m-%d') }}">
              <div class="cell-box" contenteditable="true"
                   onblur="saveCell(this)"
                   onkeydown="if(event.key==='Enter'){event.preventDefault(); this.blur();}">
                {%- for e in items -%}
                  {{- e.code -}}{% if not loop.last %}\n{% endif %}
                {%- endfor -%}
              </div>
            </td>
          {% endfor %}

          {% set s = summary_by_user.get(u.id, (0,0,0,0)) %}
          <td class="text-center summary-col">{{ s[0] }}</td>
          <td class="text-center summary-col">{{ s[1] }}</td>
          <td class="text-center summary-col">{{ s[2] }}</td>
          <td class="text-center summary-col">{{ s[3] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Chỗ ký -->
  <div class="print-only">
    <div class="sign-grid">
      <div class="box"><div class="u">NGƯỜI LẬP BẢNG</div><div class="i">(Ký, ghi rõ họ tên)</div></div>
      <div class="box"><div class="u">TRƯỞNG KHOA</div><div class="i">(Ký, ghi rõ họ tên)</div></div>
      <div class="box"><div class="u">PHÒNG TỔ CHỨC - HCQT</div><div class="i">(Ký, ghi rõ họ tên)</div></div>
      <div class="box"><div class="u">GIÁM ĐỐC</div><div class="i">(Ký, ghi rõ họ tên)</div></div>
    </div>
  </div>
</div>

<script>
async function saveCell(div){
  const td = div.closest('td');
  const code = div.innerText.trim();
  const userId = td.dataset.user;
  const work_date = td.dataset.date;

  const res = await fetch('/timesheet2/{{ sheet.id }}/cell', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({user_id: userId, work_date, code})
  });
  const j = await res.json();
  if(!j.ok){ alert(j.msg || 'Lỗi cập nhật'); }
}
function printTimesheet(){ window.print(); }
</script>
{% endblock %}
