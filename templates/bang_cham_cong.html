{% extends "layout.html" %}
{% block title %}B·∫£ng ch·∫•m c√¥ng{% endblock %}

{% block content %}
<!-- TI√äU ƒê·ªÄ CHU·∫®N C√îNG VƒÇN -->
<div class="d-none d-print-block text-center mb-3">
  <div class="row">
    <div class="col-6 text-center">
      <strong>B·ªÜNH VI·ªÜN NHI T·ªàNH GIA LAI</strong><br>
      {% if not selected_department %}
        <strong>PH√íNG T·ªî CH·ª®C - HCQT</strong>
      {% else %}
        <span style="display:inline-block; font-weight:bold; border-bottom:1px solid black; margin-top: 2px;">
          {{ selected_department.upper() }}
        </span>
      {% endif %}
    </div>
    <div class="col-6 text-center">
      <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-weight: normal; border-bottom: 1px solid black;">
          ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c
        </span>
      </div>
      {% if now %}
      <div style="margin-top: 4px;">
        <em>Gia Lai, ng√†y {{ now.strftime('%d') }} th√°ng {{ now.strftime('%m') }} nƒÉm {{ now.strftime('%Y') }}</em>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  @media print {
    .d-print-block { display: block !important; }
    .d-print-none, .btn, .sidebar, form, nav, .print-hide, .user-greeting {
      display: none !important;
    }

    html, body {
      zoom: 100%;
      margin: 0 !important;
      padding: 0 !important;
      width: 100%;
      height: 100%;
    }

    .container, .row, .main, .wrapper, .content {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    table {
      width: 100% !important;
      table-layout: auto !important;
      border-collapse: collapse;
      font-size: 9.5px;
    }

    th, td {
      padding: 4px 6px;
      border: 3px solid black;
      border-top: 3px solid black;
      border-bottom: 3px solid black;
      text-align: center;
      vertical-align: middle;
      line-height: 1.2;
      word-break: break-word;
    }

    /* C·ªôt h·ªç t√™n r·ªông h∆°n */
    th.hoten, td.hoten {
      min-width: 3.5cm;
      max-width: 5.0cm;
    }

    /* C·ªôt c·∫•p b·∫≠c ch·ª©c v·ª• nh·ªè l·∫°i v√† 2 d√≤ng */
    th.chucvu, td.chucvu {
      min-width: 1.2cm;
      max-width: 1.6cm;
      white-space: pre-line;
      line-height: 1.2;
      font-size: 9.3px;
      padding: 4px 2px;
    }

    td.code-cell {
      white-space: pre-line !important;
      font-size: 9.5px;
      line-height: 1.1;
      padding: 4px 2px;
      word-break: break-word;
    }

    th.so-cong-kl, td.so-cong-kl,
    th.so-cong-tg, td.so-cong-tg,
    th.so-cong-100, td.so-cong-100,
    th.so-cong-bhxh, td.so-cong-bhxh {
      min-width: 1.0cm !important;
      max-width: 1.2cm !important;
      text-align: center;
      white-space: normal;
    }
  }

  @page {
    size: A4 landscape;
    margin: 1cm 1cm 0.7cm 1cm;
  }
</style>


<h5 class="mt-4 mb-3 fw-bold text-uppercase text-center">
  B·∫¢NG CH·∫§M C√îNG TH√ÅNG {{ month }} NƒÇM {{ year }}
</h5>

<form method="GET" class="d-flex gap-3 flex-wrap align-items-end mb-4">
  <div>
    <label class="form-label mb-0">Khoa/Ph√≤ng:</label>
    {% if user.role == 'admin' %}
      <select name="department" class="form-select">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for dept in departments %}
          <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    {% else %}
      <input type="hidden" name="department" value="{{ selected_department }}">
      <p><strong>Khoa:</strong> {{ selected_department }}</p>
    {% endif %}
  </div>
  <div>
    <label class="form-label mb-0">Lo·∫°i h·ª£p ƒë·ªìng:</label>
    <select name="contract_type" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
      <option value="bi√™n ch·∫ø" {% if selected_contract == 'bi√™n ch·∫ø' %}selected{% endif %}>Bi√™n ch·∫ø</option>
      <option value="h·ª£p ƒë·ªìng" {% if selected_contract == 'h·ª£p ƒë·ªìng' %}selected{% endif %}>H·ª£p ƒë·ªìng</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-0">T·ª´ ng√†y:</label>
    <input type="date" name="start" class="form-control" value="{{ start_date }}">
  </div>
  <div>
    <label class="form-label mb-0">ƒê·∫øn ng√†y:</label>
    <input type="date" name="end" class="form-control" value="{{ end_date }}">
  </div>
  <div>
    <button type="submit" class="btn btn-primary">Xem b·∫£ng</button>
    <a href="/export-cham-cong?start={{ start_date }}&end={{ end_date }}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_contract %}&contract_type={{ selected_contract }}{% endif %}" class="btn btn-success">üì• Xu·∫•t Excel</a>
    <a href="{{ url_for('bang_doc_hai', department=request.args.get('department'), start=request.args.get('start'), end=request.args.get('end')) }}" class="btn btn-warning">üë∑ B·∫£ng ch·∫•m c√¥ng h∆∞·ªüng ƒë·ªôc h·∫°i</a>
    <button type="button" class="btn btn-secondary" onclick="window.print()">üñ® In</button>
  </div>
</form>

<table class="table table-bordered table-sm text-center">
  <thead>
    <tr>
      <th colspan="3" style="background-color:#d9ead3; font-weight:bold;">
        {% set contract_label = selected_contract.strip().lower() if selected_contract else '' %}
        {% if contract_label == 'h·ª£p ƒë·ªìng' %}
          H·ª¢P ƒê·ªíNG
        {% elif contract_label == 'bi√™n ch·∫ø' %}
          BI√äN CH·∫æ
        {% else %}
          LO·∫†I H·ª¢P ƒê·ªíNG
        {% endif %}
      </th>
      <th colspan="{{ days_in_month|length }}" style="background-color:#fff2cc; font-weight:bold;">NG√ÄY TRONG TH√ÅNG</th>
      <th class="so-cong-kl" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng kh√¥ng h∆∞·ªüng l∆∞∆°ng</th>
      <th class="so-cong-tg" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng h∆∞·ªüng l∆∞∆°ng TG</th>
      <th class="so-cong-100" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng ngh·ªâ vi·ªác 100%</th>
      <th class="so-cong-bhxh" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng BHXH</th>
    </tr>
    <tr>
      <th rowspan="2" style="background-color:#d9ead3;">STT</th>
      <th rowspan="2" class="hoten" style="background-color:#d9ead3;">H·ªç v√† t√™n</th>
      <th rowspan="2" style="background-color:#d9ead3;">C·∫•p b·∫≠c/ ch·ª©c v·ª•</th>
      {% for day in days_in_month %}
        <th class="ngay">{{ "%02d"|format(day.day) }}</th>
      {% endfor %}
    </tr>
    <tr>
      {% set thu_map = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'] %}
      {% for day in days_in_month %}
        {% set thu = thu_map[day.weekday()] %}
        <th class="ngay {% if day.weekday() in [5,6] or day in holidays %}weekend-holiday{% endif %}">{{ thu }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.position }}</td>
      {% for day in days_in_month %}
        {% set code = schedule_map.get((user.id, day), '') %}
        <td class="code-cell {% if day.weekday() in [5,6] or day in holidays %}weekend-holiday{% endif %}">{{ code|break_code }}</td>
      {% endfor %}
      <td>{{ summary[user.id]['kl'] }}</td>
      <td>{{ summary[user.id]['tg'] }}</td>
      <td>{{ summary[user.id]['100'] }}</td>
      <td>{{ summary[user.id]['bhxh'] }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="d-none d-print-block" style="width: 100%; font-size: 13px; margin-top: 0.5cm;">
  <div style="display: grid; grid-template-columns: 25% 25% 25% 25%;">
    <div style="text-align: center;">
      <strong>NG∆Ø·ªúI L·∫¨P B·∫¢NG</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    {% if selected_department and "ph√≤ng t·ªï ch·ª©c" not in selected_department.lower() %}
      <div style="text-align: center;">
        {% if "ph√≤ng" in selected_department.lower() %}
          <strong>TR∆Ø·ªûNG PH√íNG</strong>
        {% elif "khoa" in selected_department.lower() %}
          <strong>TR∆Ø·ªûNG KHOA</strong>
        {% endif %}
        <br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
      </div>
    {% endif %}
    <div style="text-align: center;">
      <strong>PH√íNG T·ªî CH·ª®C - HCQT</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div style="text-align: center;">
      <strong>GI√ÅM ƒê·ªêC</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
  </div>
</div>
{% endblock %}
