{% extends "layout.html" %}
{% block title %}B·∫£ng ch·∫•m c√¥ng{% endblock %}

{% block content %}

<style>
  .weekend-holiday {
    background-color: #ffd6cc !important; /* CN - ƒë·ªè nh·∫°t */
  }
  .weekend-holiday[data-weekday="5"] {
    background-color: #d9eaf7 !important; /* T7 - xanh nh·∫°t */
  }
  .weekend-holiday[data-holiday="true"] {
    background-color: #fff2cc !important; /* Ng√†y l·ªÖ - v√†ng nh·∫°t */
  }
</style>

<h5 class="mt-4 mb-3 fw-bold text-uppercase text-center">
  B·∫¢NG CH·∫§M C√îNG TH√ÅNG {{ month }} NƒÇM {{ year }}
</h5>

<form method="GET" class="d-flex gap-3 flex-wrap align-items-end mb-4">
  <div>
    <label class="form-label mb-0">Khoa/Ph√≤ng:</label>
    {% if user.role in ['admin', 'admin1'] %}
      <select name="department" class="form-select">
        <option value="">-- T·∫•t c·∫£ --</option>
        {% for dept in departments %}
          <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    {% else %}
      <input type="hidden" name="department" value="{{ selected_department }}">
      <p><strong>Khoa:</strong> {{ selected_department if selected_department else 'T·∫•t c·∫£' }}</p>
    {% endif %}
  </div>
  <div>
    <label class="form-label mb-0">Lo·∫°i h·ª£p ƒë·ªìng:</label>
    <select name="contract_type" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
      <option value="bi√™n ch·∫ø" {% if selected_contract == 'bi√™n ch·∫ø' %}selected{% endif %}>Bi√™n ch·∫ø</option>
      <option value="h·ª£p ƒë·ªìng" {% if selected_contract == 'h·ª£p ƒë·ªìng' %}selected{% endif %}>H·ª£p ƒë·ªìng</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-0">T·ª´ ng√†y:</label>
    <input type="date" name="start" class="form-control" value="{{ start_date }}">
  </div>
  <div>
    <label class="form-label mb-0">ƒê·∫øn ng√†y:</label>
    <input type="date" name="end" class="form-control" value="{{ end_date }}">
  </div>
  <div>
    <button type="submit" class="btn btn-primary">Xem b·∫£ng</button>
    <a href="/export-cham-cong?start={{ start_date }}&end={{ end_date }}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_contract %}&contract_type={{ selected_contract }}{% endif %}" class="btn btn-success">üì• Xu·∫•t Excel</a>
    <button type="button" class="btn btn-secondary" onclick="window.print()">üñ® In b·∫£ng ch·∫•m c√¥ng</button>
    <a href="{{ url_for('bang_doc_hai', department=request.args.get('department'), start=request.args.get('start'), end=request.args.get('end')) }}" class="btn btn-warning">üë∑ B·∫£ng ch·∫•m c√¥ng h∆∞·ªüng ƒë·ªôc h·∫°i</a>
    <a href="{{ url_for('theo_doi_nghi_bu') }}" class="btn btn-info">Theo d√µi ngh·ªâ b√π</a>
  </div>
</form>

<table class="table table-bordered table-sm text-center">
  <thead>
    <tr>
      <th colspan="3" style="background-color:#d9ead3; font-weight:bold;">
        {% set contract_label = selected_contract.strip().lower() if selected_contract else '' %}
        {% if contract_label == 'h·ª£p ƒë·ªìng' %}
          H·ª¢P ƒê·ªíNG
        {% elif contract_label == 'bi√™n ch·∫ø' %}
          BI√äN CH·∫æ
        {% else %}
          LO·∫†I H·ª¢P ƒê·ªíNG
        {% endif %}
      </th>
      <th colspan="{{ days_in_month|length }}" style="background-color:#fff2cc; font-weight:bold;">NG√ÄY TRONG TH√ÅNG</th>
      <th class="so-cong-kl" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng kh√¥ng h∆∞·ªüng l∆∞∆°ng</th>
      <th class="so-cong-tg" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng h∆∞·ªüng l∆∞∆°ng TG</th>
      <th class="so-cong-100" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng ngh·ªâ vi·ªác 100%</th>
      <th class="so-cong-bhxh" rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng BHXH</th>
    </tr>
    <tr>
      <th rowspan="2" style="background-color:#d9ead3;">STT</th>
      <th rowspan="2" class="hoten" style="background-color:#d9ead3;">H·ªç v√† t√™n</th>
      <th rowspan="2" style="background-color:#d9ead3;">C·∫•p b·∫≠c/ ch·ª©c v·ª•</th>
      {% for day in days_in_month %}
        {% set weekday = day.weekday() %}
        {% set is_holiday = day in holidays %}
        <th class="ngay {% if weekday in [5,6] or is_holiday %}weekend-holiday{% endif %}"
            data-weekday="{{ weekday }}"
            data-holiday="{{ 'true' if is_holiday else 'false' }}">
          {{ "%02d"|format(day.day) }}
        </th>
      {% endfor %}
    </tr>
    <tr>
      {% set thu_map = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'] %}
      {% for day in days_in_month %}
        {% set weekday = day.weekday() %}
        {% set is_holiday = day in holidays %}
        {% set thu = thu_map[weekday] %}
        <th class="ngay {% if weekday in [5,6] or is_holiday %}weekend-holiday{% endif %}"
            data-weekday="{{ weekday }}"
            data-holiday="{{ 'true' if is_holiday else 'false' }}">
          {{ thu }}
        </th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.position }}</td>
      {% for day in days_in_month %}
        {% set weekday = day.weekday() %}
        {% set is_holiday = day in holidays %}
        {% set code = schedule_map.get((user.id, day), '') %}
        <td class="code-cell {% if weekday in [5,6] or is_holiday %}weekend-holiday{% endif %}"
            data-weekday="{{ weekday }}"
            data-holiday="{{ 'true' if is_holiday else 'false' }}">
          {{ code|break_code }}
        </td>
      {% endfor %}
      <td>{{ summary[user.id]['kl'] }}</td>
      <td>{{ summary[user.id]['tg'] }}</td>
      <td>{{ summary[user.id]['100'] }}</td>
      <td>{{ summary[user.id]['bhxh'] }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
