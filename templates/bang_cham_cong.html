{% extends "layout.html" %}
{% block title %}B·∫£ng ch·∫•m c√¥ng{% endblock %}

{% block content %}
<!-- TI√äU ƒê·ªÄ CHU·∫®N C√îNG VƒÇN -->
<div class="d-none d-print-block text-center mb-3">
  <div class="row">
    <div class="col-6" style="text-align: center;">
      <div>
        <strong>B·ªÜNH VI·ªÜN NHI T·ªàNH GIA LAI</strong><br>
        {% if not selected_department %}
          <strong>PH√íNG T·ªî CH·ª®C - HCQT</strong>
        {% else %}
          <span style="display:inline-block; font-weight:bold; border-bottom:1px solid black; margin-top: 2px;">
            {{ selected_department.upper() }}
          </span>
        {% endif %}
      </div>
    </div>
    <div class="col-6 text-center">
      <strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong><br>
      <div style="margin-top: 4px;">
        <span style="display: inline-block; font-weight: normal; border-bottom: 1px solid black;">
          ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c
        </span>
      </div>
      {% if now %}
      <div style="margin-top: 4px;">
        <em>Gia Lai, ng√†y {{ now.strftime('%d') }} th√°ng {{ now.strftime('%m') }} nƒÉm {{ now.strftime('%Y') }}</em>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
    .weekend-holiday {
      background-color: #ffebcc !important;
    }

    @media print {
      .d-print-block { display: block !important; }
      .d-print-none, .btn, .sidebar, form, nav, .print-hide, .user-greeting {
        display: none !important;
      }

      html, body {
        zoom: 100%;
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
        height: 100%;
      }

      .container, .row, .main, .wrapper, .content {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      table {
        width: 100% !important;
        table-layout: auto !important;
        border-collapse: collapse;
        font-size: 9.5px;
      }

      th, td {
        padding: 4px 6px;
        border: 1px solid black;
        text-align: center;
        vertical-align: middle;
        line-height: 1.2;
        word-break: break-word;
      }

      th:first-child, td:first-child {
        min-width: 0.5cm;
      }

      th.hoten, td.hoten {
        min-width: 2.5cm;
        max-width: 3.5cm;
      }

      th:nth-child(3), td:nth-child(3) {
        min-width: 0.9cm;
        max-width: 1.1cm;
      }

      th.ketthuc, td.ketthuc {
        min-width: 1.0cm !important;
        max-width: 1.2cm;
      }

      td.ca-ma {
        display: block;
        max-height: 2.4em;
        overflow: hidden;
        line-height: 1.2em;
        white-space: normal;
        word-break: break-word;
      }
      th.ngay, td.ngay {
        min-width: 0.5cm;
        max-width: 0.6cm;
      }
      th.so-cong-kl, td.so-cong-kl,
      th.so-cong-tg, td.so-cong-tg,
      th.so-cong-100, td.so-cong-100,
      th.so-cong-bhxh, td.so-cong-bhxh {
        min-width: 1.0cm !important;
        max-width: 1.2cm !important;
      }
    }

    @page {
      size: A4 landscape;
      margin: 1cm 1cm 0.7cm 1cm;
    }

</style>

<div class="d-print-block mb-3" style="width: 100%;">
  <h5 class="mt-4 mb-3 fw-bold text-uppercase"
      style="position: relative; left: 50%; transform: translateX(-50%); text-align: center;">
    B·∫¢NG CH·∫§M C√îNG TH√ÅNG {{ month }} NƒÇM {{ year }}
  </h5>
</div>

<form method="GET" class="d-flex gap-3 flex-wrap align-items-end mb-4">
  <div>
    <label for="department" class="form-label mb-0">Khoa/Ph√≤ng:</label>
    {% if user.role == 'admin' %}      
      <select name="department" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
        {% for dept in departments %}
          <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
      </select>
    {% else %}
      <input type="hidden" name="department" value="{{ selected_department }}">
      <p><strong>Khoa:</strong> {{ selected_department }}</p>
    {% endif %}
  </div>
  <div>
    <label for="contract_type" class="form-label mb-0">Lo·∫°i h·ª£p ƒë·ªìng:</label>
    <select name="contract_type" class="form-select">
      <option value="">-- T·∫•t c·∫£ --</option>
      <option value="bi√™n ch·∫ø" {% if selected_contract == 'bi√™n ch·∫ø' %}selected{% endif %}>Bi√™n ch·∫ø</option>
      <option value="h·ª£p ƒë·ªìng" {% if selected_contract == 'h·ª£p ƒë·ªìng' %}selected{% endif %}>H·ª£p ƒë·ªìng</option>
    </select>
  </div>
  <div>
    <label class="form-label mb-0">T·ª´ ng√†y:</label>
    <input type="date" name="start" class="form-control" value="{{ start_date }}">
  </div>
  <div>
    <label class="form-label mb-0">ƒê·∫øn ng√†y:</label>
    <input type="date" name="end" class="form-control" value="{{ end_date }}">
  </div>
  <div>
    <button type="submit" class="btn btn-primary">Xem b·∫£ng</button>
    <a href="/export-cham-cong?start={{ start_date }}&end={{ end_date }}
    {% if selected_department %}&department={{ selected_department }}{% endif %}
    {% if selected_contract %}&contract_type={{ selected_contract }}{% endif %}"
    class="btn btn-success">üì• Xu·∫•t Excel</a>
    <button type="button" class="btn btn-secondary" onclick="window.print()">üñ® In</button>
  </div>
</form>

<table class="table table-bordered table-sm text-center">
  <thead>
    <tr>
      <th colspan="3" style="background-color:#d9ead3; font-weight:bold;">
        {% set contract_label = selected_contract.strip().lower() if selected_contract else '' %}
        {% if contract_label == 'h·ª£p ƒë·ªìng' %}
          H·ª¢P ƒê·ªíNG
        {% elif contract_label == 'bi√™n ch·∫ø' %}
          BI√äN CH·∫æ
        {% else %}
          LO·∫†I H·ª¢P ƒê·ªíNG
        {% endif %}
      </th>
      <th colspan="{{ days_in_month|length }}" style="background-color:#fff2cc; font-weight:bold;">NG√ÄY TRONG TH√ÅNG</th>
      <th rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng kh√¥ng h∆∞·ªüng l∆∞∆°ng</th>
      <th rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng h∆∞·ªüng l∆∞∆°ng TG</th>
      <th rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng ngh·ªâ vi·ªác 100%</th>
      <th rowspan="3" style="background-color:#d9ead3;">S·ªë c√¥ng BHXH</th>
    </tr>
    <tr>
      <th rowspan="2" style="background-color:#d9ead3;">STT</th>
      <th rowspan="2" class="hoten" style="background-color:#d9ead3;">H·ªç v√† t√™n</th>
      <th rowspan="2" style="background-color:#d9ead3;">C·∫•p b·∫≠c/ ch·ª©c v·ª•</th>

      {% for day in days_in_month %}
        <th>{{ "%02d"|format(day.day) }}</th>
      {% endfor %}
    </tr>
    <tr>
      {% set thu_map = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'] %}
      {% for day in days_in_month %}
        {% set thu = thu_map[day.weekday()] %}
        <th class="{% if day.weekday() in [5,6] or day in holidays %}weekend-holiday{% endif %}">{{ thu }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for user in users %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.position }}</td>
      {% for day in days_in_month %}
        {% set code = schedule_map.get((user.id, day), '') %}
        <td class="{% if day.weekday() in [5,6] or day in holidays %}weekend-holiday{% endif %}">{{ code }}</td>
      {% endfor %}
      <td>{{ summary[user.id]['kl'] }}</td>
      <td>{{ summary[user.id]['tg'] }}</td>
      <td>{{ summary[user.id]['100'] }}</td>
      <td>{{ summary[user.id]['bhxh'] }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="d-none d-print-block" style="width: 100%; font-size: 13px; margin-top: 0.5cm;">
  <div style="display: grid; grid-template-columns: 20% 20% 20% 20% 20%;">
    <div style="text-align: left;">
      <strong>N∆°i nh·∫≠n:</strong><br>
      - Ban Gi√°m ƒë·ªëc<br>
      - C√°c khoa/ph√≤ng<br>
      - ƒêƒÉng website<br>
      - L∆∞u: VP, KH-CNTT
    </div>
    <div style="text-align: center;">
      <strong>NG∆Ø·ªúI L·∫¨P B·∫¢NG</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    {% set dept_lower = (selected_department | default('') | lower) %}
    {% if dept_lower and dept_lower != 'ph√≤ng t·ªï ch·ª©c - hcqt' %}
      <div style="text-align: center;">
        {% if "ph√≤ng" in dept_lower %}
          <strong>TR∆Ø·ªûNG PH√íNG</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
        {% elif "khoa" in dept_lower %}
          <strong>TR∆Ø·ªûNG KHOA</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
        {% endif %}
      </div>
    {% endif %}
    <div style="text-align: center;">
      <strong>PH√íNG T·ªî CH·ª®C - HCQT</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
    <div style="text-align: center;">
      <strong>GI√ÅM ƒê·ªêC</strong><br><em>(K√Ω, ghi r√µ h·ªç t√™n)</em>
    </div>
  </div>
</div>

<script>
document.querySelector("form").addEventListener("submit", function(e) {
  const printChecked = document.getElementById("print_filter").checked;
  const contractType = document.querySelector("select[name='contract_type']").value;
  if (printChecked && !contractType) {
    alert("Vui l√≤ng ch·ªçn lo·∫°i h·ª£p ƒë·ªìng n·∫øu mu·ªën l·ªçc khi in!");
    e.preventDefault();
  }
});
</script>{% endblock %}